name: Docker Image CI

on: [push]

jobs:
  
  build-upload:
    name: Build Muilti-Platform Image and Upload to Docker Hub
    runs-on: ubuntu-latest
    steps:
    - 
      name: Build Docker buildx
      run: |
        export DOCKER_CLI_EXPERIMENTAL=enabled
        export DOCKER_BUILDKIT=1
        docker build --platform=local -o . git://github.com/docker/buildx
        mkdir -p ~/.docker/cli-plugins && mv buildx ~/.docker/cli-plugins/docker-buildx

    - 
      name: Docker Version
      run: |
        echo "DOCKER VERSION:"
        docker version
        echo "BUILDX VERSION:"
        docker buildx version

    - 
      name: Checkout Repo
      uses: actions/checkout@v1

    - 
      name: Create Builder Instance
      run: |
        docker run --rm --privileged docker/binfmt:66f9012c56a8316f9244ffd7622d7c21c1f6f28d
        docker buildx create --use --name mybuilder

    - 
      name: Build and Upload
      env:
        DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
      run: |
        # Variables
        TAG=$(date +%y.%m)
        NAME=silentdigit/letsencrypt

        # Build image
        docker build --tag ${NAME}:${TAG} .

        # Build image as TAG version
        docker buildx build -t ${NAME}:${TAG} --platform=linux/arm,linux/arm64,linux/amd64 . --push

        # Build image as latest version
        docker buildx build -t ${NAME}:latest --platform=linux/arm,linux/arm64,linux/amd64 . --push
